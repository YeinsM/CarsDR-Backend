# .github/workflows/track-merged-branches.yml
name: Track Merged Branches

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-md:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ✅ Repo checked out
        run: echo "✅ Repository successfully checked out."

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "✅ Git user configured."

      - name: Update merged-branches.md
        run: |
          echo "🚀 Starting merged-branches.md update..."
          FILE="merged-branches.md"
          BRANCH_NAME="${{ github.head_ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "🔀 Current branch: $BRANCH_NAME"
          echo "🗒️ PR title: $PR_TITLE"
          echo "🔢 PR number: $PR_NUMBER"

          # Skip if this is the update branch itself
          if [ "$BRANCH_NAME" = "update/merged-branches" ]; then
            echo "⏭️ Skipping logging for the update branch itself."
            exit 0
          fi

          # Generate new entry
          MERGE_DATE=$(date "+%Y/%m/%d")
          MERGE_TIME=$(date "+%H:%M")
          NEW_ENTRY="[$MERGE_TIME] - $BRANCH_NAME — $PR_TITLE (PR #$PR_NUMBER)"

          echo "📝 New entry: $NEW_ENTRY"

          # Create or update the file
          if [ ! -f "$FILE" ]; then
            echo "📄 Creating new $FILE"
            cat > "$FILE" << EOF
          # Merged Branches History

          ## Last
          ---------------------------
          Merged on $MERGE_DATE
          $NEW_ENTRY

          ## Previous
          ---------------------------
          EOF
          else
            echo "📄 Updating existing $FILE"
            
            # Extract current Last section content (everything between "## Last" and "## Previous")
            CURRENT_LAST=$(awk '/^## Last/,/^## Previous/ {
              if ($0 ~ /^## Previous/) exit;
              if ($0 !~ /^## Last/ && $0 !~ /^--*$/ && $0 !~ /^$/) print $0
            }' "$FILE")

            # Extract Previous section content (everything after "## Previous")
            CURRENT_PREVIOUS=$(awk '/^## Previous/,EOF {
              if ($0 !~ /^## Previous/ && $0 !~ /^--*$/) print $0
            }' "$FILE")

            echo "🔍 Debug - Current Last content:"
            echo "$CURRENT_LAST"
            echo "🔍 Debug - Current Previous content:"
            echo "$CURRENT_PREVIOUS"

            # Create updated file with new structure
            {
              echo "# Merged Branches History"
              echo ""
              echo "## Last"
              echo "---------------------------"
              echo "Merged on $MERGE_DATE"
              echo "$NEW_ENTRY"
              echo ""
              echo "## Previous"
              echo "---------------------------"
              
              # Add previous Last content to Previous section (if it exists and is not empty)
              if [ -n "$CURRENT_LAST" ] && [ "$CURRENT_LAST" != "" ]; then
                echo "$CURRENT_LAST"
                # Add blank line only if there will be more content below
                if [ -n "$CURRENT_PREVIOUS" ] && [ "$CURRENT_PREVIOUS" != "" ]; then
                  echo ""
                fi
              fi

              # Add existing Previous content if it exists
              if [ -n "$CURRENT_PREVIOUS" ] && [ "$CURRENT_PREVIOUS" != "" ]; then
                echo "$CURRENT_PREVIOUS"
              fi
            } > "$FILE"
          fi

          echo "✅ merged-branches.md updated successfully."
          echo "📄 Final content:"
          cat "$FILE"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet merged-branches.md; then
            echo "No changes detected in merged-branches.md"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in merged-branches.md"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or update Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "📝 Update merged-branches.md after merging PR #${{ github.event.pull_request.number }}"
          branch: update/merged-branches
          base: ${{ github.event.pull_request.base.ref }}
          title: "chore: update merged-branches.md with latest merge"
          body: |
            🤖 **Automated Update**
            
            This PR updates `merged-branches.md` with the latest merged branch information.
            
            **Merged Branch:** `${{ github.head_ref }}`
            **PR Title:** ${{ github.event.pull_request.title }}
            **PR Number:** #${{ github.event.pull_request.number }}
            
            This PR will be automatically created after each merge to keep track of all merged branches.
          delete-branch: false
          assignees: ${{ github.event.pull_request.user.login }}

      - name: ✅ Workflow complete
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "✅ Pull request created/updated for merged-branches.md"
          else
            echo "✅ No changes needed for merged-branches.md"
          fi
